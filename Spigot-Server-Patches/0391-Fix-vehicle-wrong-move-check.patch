From 64226dc0177528510c4d26309c25d3853eca065c Mon Sep 17 00:00:00 2001
From: LuckerCracker <luckerxd@yandex.ru>
Date: Mon, 7 Mar 2022 13:49:35 +0400
Subject: [PATCH] Fix vehicle wrong move check


diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 59d526329..26f1baedb 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -346,6 +346,7 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                 // Paper start - Prevent moving into unloaded chunks
                 if (player.world.paperConfig.preventMovingIntoUnloadedChunks && !worldserver.isChunkLoaded((int) Math.floor(packetplayinvehiclemove.getX()) >> 4, (int) Math.floor(packetplayinvehiclemove.getZ()) >> 4, false)) {
                     this.networkManager.sendPacket(new PacketPlayOutVehicleMove(entity));
+                    this.stopRidingAndTeleport(entity); // Paper
                     return;
                 }
                 // Paper end
@@ -354,6 +355,7 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                 // CraftBukkit end
                     PlayerConnection.LOGGER.warn("{} (vehicle of {}) moved too quickly! {},{},{}", entity.getName(), this.player.getName(), Double.valueOf(d6), Double.valueOf(d7), Double.valueOf(d8));
                     this.networkManager.sendPacket(new PacketPlayOutVehicleMove(entity));
+                    this.stopRidingAndTeleport(entity); // Paper
                     return;
                 }
 
@@ -389,6 +391,7 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                     entity.setLocation(d0, d1, d2, f, f1);
                     player.setLocation(d3, d4, d5, this.player.yaw, this.player.pitch); // CraftBukkit
                     this.networkManager.sendPacket(new PacketPlayOutVehicleMove(entity));
+                    this.stopRidingAndTeleport(entity); // Paper
                     return;
                 }
 
@@ -470,6 +473,12 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
         }
     }
 
+    // Paper
+    private void stopRidingAndTeleport(Entity to) {
+        this.player.setPosition(to.getX(), to.getY(), to.getZ());
+        this.player.stopRiding();
+    }
+
     public void a(PacketPlayInTeleportAccept packetplayinteleportaccept) {
         PlayerConnectionUtils.ensureMainThread(packetplayinteleportaccept, this, this.player.x());
         if (packetplayinteleportaccept.a() == this.teleportAwait && this.teleportPos != null) { // CraftBukkit
-- 
2.32.0.windows.2

