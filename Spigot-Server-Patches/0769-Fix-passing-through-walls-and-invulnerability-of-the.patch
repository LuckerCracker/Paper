From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: LuckerCracker <luckerxd@yandex.ru>
Date: Sat, 14 Oct 2023 14:24:14 +0400
Subject: [PATCH] Fix passing through walls and invulnerability of the player
 on entities


diff --git a/src/main/java/net/minecraft/server/network/PlayerConnection.java b/src/main/java/net/minecraft/server/network/PlayerConnection.java
index 7044620e7fb5874913e7911adb606668a76ac0de..57b6ff477a98a8dd0827ac68897b2393451eaeb3 100644
--- a/src/main/java/net/minecraft/server/network/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/network/PlayerConnection.java
@@ -580,6 +580,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                 // Paper start - Prevent moving into unloaded chunks
                 if (player.world.paperConfig.preventMovingIntoUnloadedChunks && worldserver.getChunkIfLoadedImmediately((int) Math.floor(packetplayinvehiclemove.getX()) >> 4, (int) Math.floor(packetplayinvehiclemove.getZ()) >> 4) == null) {
                     this.networkManager.sendPacket(new PacketPlayOutVehicleMove(entity));
+                    this.stopRidingAndTeleport(entity);
                     return;
                 }
                 // Paper end
@@ -588,6 +589,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                 // CraftBukkit end
                     PlayerConnection.LOGGER.warn("{} (vehicle of {}) moved too quickly! {},{},{}", entity.getDisplayName().getString(), this.player.getDisplayName().getString(), d6, d7, d8);
                     this.networkManager.sendPacket(new PacketPlayOutVehicleMove(entity));
+                    this.stopRidingAndTeleport(entity);
                     return;
                 }
 
@@ -623,6 +625,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
                     entity.setLocation(d0, d1, d2, f, f1);
                     player.setLocation(d0, d1, d2, this.player.yaw, this.player.pitch); // CraftBukkit
                     this.networkManager.sendPacket(new PacketPlayOutVehicleMove(entity));
+                    this.stopRidingAndTeleport(entity);
                     return;
                 }
 
@@ -704,6 +707,11 @@ public class PlayerConnection implements PacketListenerPlayIn {
         }
     }
 
+    private void stopRidingAndTeleport(Entity to) {
+        this.player.setPosition(to.locX(), to.locY(), to.locZ());
+        this.player.stopRiding();
+    }
+
     private boolean a(Entity entity) {
         return entity.world.a(entity.getBoundingBox().g(0.0625D).b(0.0D, -0.55D, 0.0D)).allMatch(BlockBase.BlockData::isAir);
     }
